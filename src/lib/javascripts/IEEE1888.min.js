function uuid(){return"{0}{1}-{2}-{3}-{4}-{5}{6}{7}".format(mt_rand("0","0xffff"),mt_rand("0","0xffff"),mt_rand("0","0xffff"),("0x"+mt_rand("0","0x0fff")|16384).toString(16),("0x"+mt_rand("0","0x3fff")|32768).toString(16),mt_rand("0","0xffff"),mt_rand("0","0xffff"),mt_rand("0","0xffff"))}function mt_rand(t,i){var r=arguments.length;if(0===r)t=0,i=2147483647;else{if(1===r)throw Error("Warning: mt_rand() expects exactly 2 parameters, 1 given");t=parseInt(t,16),i=parseInt(i,16)}return hex=(Math.floor(Math.random()*(i-t+1))+t).toString(16),"0000".substr(0,4-hex.length)+hex}function isoDate(t){var i=-t.getTimezoneOffset(),r=0>i?"-":"+";return t.getFullYear()+"-"+pad(t.getMonth()+1)+"-"+pad(t.getDate())+"T"+pad(t.getHours())+":"+pad(t.getMinutes())+":"+pad(t.getSeconds())+r+pad(i/60)+":"+pad(i%60)}function isoDateWithoutTimestamp(t){-t.getTimezoneOffset();return t.getFullYear()+"-"+pad(t.getMonth()+1)+"-"+pad(t.getDate())+"T"+pad(t.getHours())+":"+pad(t.getMinutes())+":"+pad(t.getSeconds())}function pad(t){return norm=Math.abs(Math.floor(t)),(10>norm?"0":"")+norm}var _tmp_ieee1888={};String.prototype.format||(String.prototype.format=function(){var t=arguments;return this.replace(/{(\d+)}/g,function(i,r){return void 0!==t[r]?t[r]:i})});var IEEE1888=Class.extend({init:function(){this.keyAttr={},this.responseFunc=this.queryResponse,this.callbackFunc=null,this.url="",this.point_id=[],this._tmp_data={},this.key=[],this.error_point_id=[]},resetKeyAttr:function(){this.keyAttr={}},setKeyAttr:function(t,i){this.keyAttr[t]=i},getKeyAttr:function(){return JSON.parse(JSON.stringify(this.keyAttr))},resetKey:function(){this.key=[]},addKey:function(t){this.key.push(t)},removeKey:function(t){for(var i=this.key,r=0;r<i.length;r++)t===i[r].attr.id&&(i.splice(r,1),this.error_point_id.push(t))},resetPointID:function(){this.point_id=[]},setPointID:function(t){this.point_id=t},getPointID:function(){return JSON.parse(JSON.stringify(this.point_id))},removePointID:function(t){var i=this.point_id.indexOf(t);i>-1&&(this.point_id.splice(i,1),this.error_point_id.push(t))},setURL:function(t){this.url=t},getURL:function(){return JSON.parse(JSON.stringify(this.url))},setCallbackFunc:function(t){this.callbackFunc=t},setResponseFunc:function(t){this.responseFunc=t},query:function(){this.startLog(),this.queryRequest()},queryRequest:function(t){var i=[],r=[],e=[],n=[],o=uuid(),s=JSON.parse(JSON.stringify(this.point_id));if(this.key.length>0){if(i=i.concat(this.key),i.length<=0)return console.log("no point id receive."),0}else{if(s.length<=0)return console.log("no point id receive."),0;for(var h=0;h<s.length;h++)i[h]=[],i[h].attr=JSON.parse(JSON.stringify(this.keyAttr)),i[h].attr.id=s[h]}null==t?(this._tmp_data={},r.attr={type:"storage",id:o,acceptableSize:"1000"}):r.attr="retry"==t?{type:"storage",id:o,acceptableSize:"1000"}:{type:"storage",id:o,acceptableSize:"1000",cursor:t},r.key_ar_at=i,e.query_attr=r,n.header=e;var p=new SOAPClientParameters;return p.add("transport",n),_tmp_ieee1888[o]=this,""==this.url?(alert("cannot get service url data"),0):void SOAPClient.invoke(this.url,"query",p,!0,this.responseFunc)},queryResponse:function(t){var i=t.transport.header.query.id;if(t.transport.header.hasOwnProperty("error")){var r=t.transport.header.error;if(console.log(r),-1===r.indexOf("was not found"))return 0;var e=r.split(" ",1)[0],n=_tmp_ieee1888[i]._tmp_data;n.hasOwnProperty("point")||(n.point={}),n.point[e]=null,0==_tmp_ieee1888[i].point_id.length?(_tmp_ieee1888[i].removeKey(e),_tmp_ieee1888[i].key.length>0?_tmp_ieee1888[i].queryRequest("retry"):_tmp_ieee1888[i].callbackFunc(n.point)):(_tmp_ieee1888[i].removePointID(e),_tmp_ieee1888[i].point_id.length>0?_tmp_ieee1888[i].queryRequest("retry"):_tmp_ieee1888[i].callbackFunc(n.point)),delete _tmp_ieee1888[i]}else{var o=t.transport.body.point,s=t.transport.body.id[0];if(null!==t.transport.header.query.cursor){var n=_tmp_ieee1888[i]._tmp_data;if(n.hasOwnProperty("point"))for(var h in o)n.point.hasOwnProperty(h)&&null!=o[h]?(n.point[h].value=n.point[h].value.concat(o[h].value),n.point[h].time=n.point[h].time.concat(o[h].time)):n.point.hasOwnProperty(h)&&null==o[h]||(n.point[h]=o[h]);else n.point=o;_tmp_ieee1888[i]._tmp_data=n,_tmp_ieee1888[i].updateLog();var p=t.transport.header.query.cursor;_tmp_ieee1888[i].queryRequest(p),delete _tmp_ieee1888[i]}else{var n=_tmp_ieee1888[i]._tmp_data;if(n.hasOwnProperty("point"))for(var h in o)n.point.hasOwnProperty(h)&&null!=o[h]?(n.point[h].value=n.point[h].value.concat(o[h].value),n.point[h].time=n.point[h].time.concat(o[h].time)):n.point.hasOwnProperty(h)&&null==o[h]||(n.point[h]=o[h]);else n.point=o;_tmp_ieee1888[i]._tmp_data=n,_tmp_ieee1888[i].endLog();var a=_tmp_ieee1888[i].point_id.indexOf(s);_tmp_ieee1888[i].point_id.splice(a,1),_tmp_ieee1888[i].callbackFunc(n.point),delete _tmp_ieee1888[i]}}},querySplit:function(){this.startLog();var t=JSON.parse(JSON.stringify(this.point_id));if(t.length<=0)return alert("no point id receive."),0;for(var i=0;i<t.length;i++)this.querySplitRequest(t[i])},querySplitRequest:function(t,i){var r=[],e=[],n=[],o=[],s=uuid();r[0]=[],r[0].attr=JSON.parse(JSON.stringify(this.keyAttr)),r[0].attr.id=t,null==i?(this._tmp_data={},e.attr={type:"storage",id:s,acceptableSize:"1000"}):e.attr="retry"==i?{type:"storage",id:s,acceptableSize:"1000"}:{type:"storage",id:s,acceptableSize:"1000",cursor:i},e.key_ar_at=r,n.query_attr=e,o.header=n;var h=new SOAPClientParameters;return h.add("transport",o),_tmp_ieee1888[s]=this,""==this.url?(alert("cannot get service url data"),0):void SOAPClient.invoke(this.url,"query",h,!0,this.responseFunc)},querySplitResponse:function(t){var i=t.transport.header.query.id;if(t.transport.header.hasOwnProperty("error")){var r=t.transport.header.error;if(console.log(r),-1!==r.indexOf("was not found")){var e=r.split(" ",1)[0],n=_tmp_ieee1888[i]._tmp_data;n.hasOwnProperty("point")||(n.point={}),n.point[e]=null,_tmp_ieee1888[i]._tmp_data=n,_tmp_ieee1888[i].updateLog();var o=_tmp_ieee1888[i].point_id.indexOf(e);o>-1&&(_tmp_ieee1888[i].point_id.splice(o,1),_tmp_ieee1888[i].error_point_id.push(e)),_tmp_ieee1888[i].point_id.length>0?_tmp_ieee1888[i].queryRequest("retry"):_tmp_ieee1888[i].callbackFunc(n.point),delete _tmp_ieee1888[i]}}else{var s=t.transport.body.point,h=t.transport.body.id[0];if(null!==t.transport.header.query.cursor){var n=_tmp_ieee1888[i]._tmp_data;if(n.hasOwnProperty("point"))for(var p in s)n.point.hasOwnProperty(p)&&null!=s[p]?(n.point[p].value=n.point[p].value.concat(s[p].value),n.point[p].time=n.point[p].time.concat(s[p].time)):n.point.hasOwnProperty(p)&&null==s[p]||(n.point[p]=s[p]);else n.point=s;_tmp_ieee1888[i]._tmp_data=n,_tmp_ieee1888[i].updateLog();var a=t.transport.header.query.cursor;_tmp_ieee1888[i].querySplitRequest(h,a),delete _tmp_ieee1888[i]}else{var n=_tmp_ieee1888[i]._tmp_data;if(n.hasOwnProperty("point"))for(var p in s)n.point.hasOwnProperty(p)&&null!=s[p]?(n.point[p].value=n.point[p].value.concat(s[p].value),n.point[p].time=n.point[p].time.concat(s[p].time)):n.point.hasOwnProperty(p)&&null==s[p]||(n.point[p]=s[p]);else n.point=s;_tmp_ieee1888[i]._tmp_data=n,_tmp_ieee1888[i].endLog();var u=_tmp_ieee1888[i].point_id.indexOf(h);_tmp_ieee1888[i].point_id.splice(u,1),0==_tmp_ieee1888[i].point_id.length&&_tmp_ieee1888[i].callbackFunc(n.point),delete _tmp_ieee1888[i]}}},queryAsync:function(){this.startLog();var t=JSON.parse(JSON.stringify(this.point_id));if(t.length<=0)return alert("no point id receive."),0;this.responseFunc=this.queryAsyncResponse;for(var i=0;i<t.length;i++)this.querySplitRequest(t[i])},queryAsyncResponse:function(t){var i=t.transport.header.query.id;if(t.transport.header.hasOwnProperty("error")){var r=t.transport.header.error;if(console.log(r),-1===r.indexOf("was not found"))return 0;var e=r.split(" ",1)[0],n=_tmp_ieee1888[i]._tmp_data;n.hasOwnProperty("point")||(n.point={}),n.point[e]=null,_tmp_ieee1888[i]._tmp_data=n,_tmp_ieee1888[i].updateLog();var o=_tmp_ieee1888[i].point_id.indexOf(e);o>-1&&(_tmp_ieee1888[i].point_id.splice(o,1),_tmp_ieee1888[i].error_point_id.push(e)),_tmp_ieee1888[i].point_id.length>0?_tmp_ieee1888[i].queryRequest("retry"):_tmp_ieee1888[i].callbackFunc(n.point),delete _tmp_ieee1888[i]}else{var s=t.transport.body.point,h=t.transport.body.id[0];if(null!==t.transport.header.query.cursor){var n=_tmp_ieee1888[i]._tmp_data;if(n.hasOwnProperty("point"))for(var p in s)n.point.hasOwnProperty(p)&&null!=s[p]?(n.point[p].value=n.point[p].value.concat(s[p].value),n.point[p].time=n.point[p].time.concat(s[p].time)):n.point.hasOwnProperty(p)&&null==s[p]||(n.point[p]=s[p]);else n.point=s;_tmp_ieee1888[i]._tmp_data=n,_tmp_ieee1888[i].updateLog();var a=t.transport.header.query.cursor;_tmp_ieee1888[i].querySplitRequest(h,a)}else{var n=_tmp_ieee1888[i]._tmp_data;if(n.hasOwnProperty("point"))for(var p in s)n.point.hasOwnProperty(p)&&null!=s[p]?(n.point[p].value=n.point[p].value.concat(s[p].value),n.point[p].time=n.point[p].time.concat(s[p].time)):n.point.hasOwnProperty(p)&&null==s[p]||(n.point[p]=s[p]);else n.point=s;_tmp_ieee1888[i]._tmp_data=n,_tmp_ieee1888[i].endLog();var u={};u[h]=n.point[h],_tmp_ieee1888[i].callbackFunc(u)}}},startLog:function(){var t=this.getPointID(),i=this.getKeyAttr(),r=new Date,e=new Date;i.hasOwnProperty("gt")?r=new Date(i.gt):i.hasOwnProperty("gteq")&&(r=new Date(i.gteq)),i.hasOwnProperty("lt")?e=new Date(i.lt):i.hasOwnProperty("lteq")&&(e=new Date(i.lteq));var n=(e.getTime()-r.getTime())/864e5,o=1440*n*t.length,s=o/1e3,h={round:0,total:parseInt(s+1),percent:0,query_start:""+r,query_end:""+e,status:"loading...",request_from:"storage"};localStorage.query_status=JSON.stringify(h)},updateLog:function(){var t=JSON.parse(localStorage.query_status);t.round++,t.percent=t.round/t.total*100,localStorage.query_status=JSON.stringify(t)},endLog:function(){var t=JSON.parse(localStorage.query_status);t.round++,t.percent=t.round/t.total*100,t.status="complete."}});
